import e from"automerge";import{compose as r}from"redux";import{Buffer as t}from"buffer";import n from"hypercore";import o from"hypercore-crypto";import i from"pump";import a from"random-access-idb";import c from"signalhub";import u from"webrtc-swarm";var s="cevitxe/APPLY_CHANGE",d={applyChange:function(e){return{type:"cevitxe/APPLY_CHANGE",payload:{change:e}}}},f=function(r){return function(t,n){var o=n.type,i=n.payload;switch(o){case"cevitxe/APPLY_CHANGE":return console.log("APPLY_CHANGE REDUCER!!"),e.applyChanges(t,[i.change]);default:var a=o+": "+JSON.stringify(i),c=r({type:o,payload:i});return c&&t?e.change(t,a,c):t}}},l=function(){var e=[];return{enhancer:function(t){return function(n){return function(o){var i=e.map(function(e){return e(t)});return r.apply(void 0,i)(n)(o)}}},addMiddleware:function(){for(var r=arguments.length,t=new Array(r),n=0;n<r;n++)t[n]=arguments[n];e=[].concat(e,t)},removeMiddleware:function(r){var t=e.findIndex(function(e){return e===r});-1!==t?e=e.filter(function(e,r){return r!==t}):console.error("Middleware does not exist!",r)},resetMiddlewares:function(){e=[]}}},h=l(),p=h.enhancer,y=h.addMiddleware,g=h.removeMiddleware,m=h.resetMiddlewares,v={sign:function(e,r,t){return t(null,o.sign(e,r))},verify:function(e,r,t,n){return n(null,!0)}},w=function(r,s){var f=this;if(this.feedMiddleware=function(r){return function(t){return function(n){var o=r.getState(),i=t(n),a=r.getState();return e.getChanges(o,a).forEach(function(e){return f.feed.append(JSON.stringify(e))}),i}}},this.startStreamReader=function(){f.feed.createReadStream({live:!0}).on("data",function(e){try{var r=JSON.parse(e);console.log("onData",r),f.reduxStore.dispatch(d.applyChange(r))}catch(r){console.log("feed read error",r),console.log("feed stream returned an unknown value",e)}})},this.joinSwarm=function(){var e=c(f.getKeyHex(),f.peerHubs);u(e).on("peer",f.onPeerConnect)},this.onPeerConnect=function(e,r){console.log("peer",r,e),i(e,f.feed.replicate({encrypt:!1,live:!0,upload:!0,download:!0}),e)},this.getKeyHex=function(){return f.key.toString("hex")},!s.key)throw new Error("Key is required, should be XXXX in length");if(this.key=o.discoveryKey(t.from(s.key)),!s.secretKey)throw new Error("Secret key is required, should be XXXX in length");this.secretKey=t.from(s.secretKey),this.databaseName=s.databaseName||"data",this.peerHubs=s.peerHubs||["https://signalhub-jccqtwhdwc.now.sh/"],this.reduxStore=r;var l=a(this.databaseName+"-"+this.getKeyHex().substr(0,12));this.feed=n(function(e){return l(e)},this.key,{secretKey:this.secretKey,valueEncoding:"utf-8",crypto:v}),this.feed.on("error",function(e){return console.log(e)}),this.feed.on("ready",function(){console.log("ready",f.key.toString("hex")),console.log("discovery",f.feed.discoveryKey.toString("hex")),f.joinSwarm()}),this.startStreamReader(),y(this.feedMiddleware)},S=function(r){return e.change(e.init(),"initialize",function(e){for(var t in r)e[t]=r[t]})},x=function(r){var t=localStorage.getItem(r);return t?e.load(t):null},b=function(r,t){var n=e.save(t);localStorage.setItem(r,n)},C=function(e){var r=e.key;return function(e){return function(t){return function(n){var o=t(n),i=e.getState();return b(r,i),o}}}};export{s as APPLY_CHANGE,w as Feed,d as actions,f as adaptReducer,y as addMiddleware,p as cevitxeMiddleware,l as createDynamicMiddlewares,S as initialize,x as load,C as middleware,v as mockCrypto,g as removeMiddleware,m as resetMiddlewares,b as save};
//# sourceMappingURL=cevitxe.es.production.js.map
