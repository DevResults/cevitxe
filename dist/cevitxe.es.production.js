import e from"automerge";import{Buffer as t}from"buffer";import r from"hypercore";import n from"hypercore-crypto";import o from"pump";import a from"random-access-idb";import{createStore as i,applyMiddleware as c}from"redux";import l from"signalhub";import f from"webrtc-swarm";var u="cevitxe/APPLY_CHANGE",s=function(t){return function(r,n){var o=n.type,a=n.payload;switch(o){case"cevitxe/APPLY_CHANGE":console.log("APPLY_CHANGE REDUCER!!!!",a);var i=a.change,c=r;"initialize"===i.message&&(c=e.init(),console.log("found initialize",i));var l=e.applyChanges(c,[i]);return console.log(l),l;default:var f=o+": "+JSON.stringify(a),u=t({type:o,payload:a});return u&&r?e.change(r,f,u):r}}};function d(){return(d=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}var p=function(t){return e.change(e.init(),"initialize",function(e){for(var r in t)e[r]=t[r]})},g={sign:function(e,t,r){return r(null,n.sign(e,t))},verify:function(e,t,r,n){return n(null,!0)}},m="ecc6212465b39a9a704d564f07da0402af210888e730f419a7faf5f347a33b3d",v="2234567890abcdef1234567880abcdef1234567890abcdef1234567890fedcba",y=n.discoveryKey(t.from(m)),h=t.from(v),S=function(){var t,n,u,s=function(r){return function(n){return function(o){var a=r.getState(),i=n(o);if(o.payload.fromCevitxe)return console.log("already from cevitxe, skipping the feed write"),i;var c=r.getState(),l=a||e.init();return console.log("existingState",l),console.log("nextState",c),e.getChanges(l,c).forEach(function(e){return t.append(JSON.stringify(e))}),i}}},m=function(e,r){console.log("peer",r,e),o(e,t.replicate({encrypt:!1,live:!0,upload:!0,download:!0}),e)},v=function(){return y.toString("hex")};return{createStore:function(o){return new Promise(function(S,b){n=o.peerHubs||["https://signalhub-jccqtwhdwc.now.sh/"];var w=a((o.databaseName||"data")+"-"+v().substr(0,12));(t=r(function(e){return w(e)},y,{secretKey:h,valueEncoding:"utf-8",crypto:g})).on("error",function(e){return console.log(e)}),t.on("ready",function(){if(console.log("ready",y.toString("hex")),console.log("discovery",t.discoveryKey.toString("hex")),a=l(v(),n),f(a).on("peer",m),u=function(e){var t,r=[].concat(e.middlewares?e.middlewares:[],[s]);return console.log("adding a feed-enabled reducer here"),e.preloadedState?(t=p(e.preloadedState),console.log("initialized state",t),console.log("creating redux store with initial state",t),i(e.reducer,t,c.apply(void 0,r))):(console.log("creating redux store without initial state"),i(e.reducer,c.apply(void 0,r)))}(d({},o,{preloadedState:0===t.length?o.preloadedState:null})),0===t.length){var r=u.getState();e.getChanges(e.init(),r).forEach(function(e){return t.append(JSON.stringify(e))}),console.log("writing initial state to feed")}var a;S(u)}),t.createReadStream({live:!0}).on("data",function(e){var t=JSON.parse(e);console.log("onData",t),u.dispatch(function(e){return{type:"cevitxe/APPLY_CHANGE",payload:{change:e,fromCevitxe:!0}}}(t))})})}}}().createStore;export{u as APPLY_CHANGE,s as adaptReducer,S as createStore,p as initialize,m as keyString,g as mockCrypto,v as secretKeyString};
//# sourceMappingURL=cevitxe.es.production.js.map
